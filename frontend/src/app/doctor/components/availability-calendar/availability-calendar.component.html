<div class="availability-calendar">
  <!-- Calendar Header -->
  <div class="calendar-header">
    <div class="calendar-nav">
      <button type="button" class="btn btn-secondary" (click)="previousMonth()">
        <span class="icon">â€¹</span>
      </button>
      <h3 class="calendar-title">{{ monthName() }}</h3>
      <button type="button" class="btn btn-secondary" (click)="nextMonth()">
        <span class="icon">â€º</span>
      </button>
    </div>
    <button type="button" class="btn btn-primary" (click)="goToToday()">
      Hoy
    </button>
  </div>

  <!-- Calendar Grid -->
  <div class="calendar-grid">
    <!-- Day Headers -->
    <div class="day-headers">
      <div class="day-header weekend">Dom</div>
      <div class="day-header">Lun</div>
      <div class="day-header">Mar</div>
      <div class="day-header">MiÃ©</div>
      <div class="day-header">Jue</div>
      <div class="day-header">Vie</div>
      <div class="day-header weekend">SÃ¡b</div>
    </div>

    <!-- Calendar Days -->
    <div class="calendar-days">
      @for (day of calendarDays(); track day.date.toISOString()) {
        <div
          class="calendar-day"
          [class.current-month]="day.isCurrentMonth"
          [class.today]="day.isToday"
          [class.selected]="isDaySelected(day)"
          [class.has-availability]="day.availability.length > 0"
          [class.has-booked]="getBookedBlocksForDay(day) > 0"
          [class.weekend]="isWeekend(day)"
          [class.past-day]="day.date < now"
          (click)="selectDayWithConfigure(day)"
        >
          <div class="day-number">{{ day.date.getDate() }}</div>
          
          @if (day.availability.length > 0) {
            <div class="day-availability">
              <div class="availability-summary">
                {{ getDayAvailabilitySummary(day) }}
              </div>
              
              @if (day.availability.length === 1) {
                <div class="single-availability">
                  {{ day.availability[0].startAt | date: 'HH:mm' }} -
                  {{ day.availability[0].endAt | date: 'HH:mm' }}
                </div>
              } @else if (day.availability.length > 1) {
                <div class="multiple-availability">
                  {{ day.availability.length }} horarios
                </div>
              }
            </div>
          }
          
          @if (getBookedBlocksForDay(day) > 0) {
            <div class="booking-indicator">ðŸ“…</div>
          }
        </div>
      }
    </div>
  </div>

  <!-- Selected Day Details -->
  @if (selectedDate(); as currentSelectedDate) {
    <div class="selected-day-details">
      <h4>Agenda del {{ currentSelectedDate | date: 'EEEE d MMMM' }}</h4>
      
      @if (groupedAvailability(); as grouped) {
        @if (grouped && grouped[currentSelectedDate.toDateString()] && grouped[currentSelectedDate.toDateString()].length > 0) {
          <div class="day-schedule">
            @for (avail of grouped[currentSelectedDate.toDateString()] || []; track avail.id) {
              <div class="availability-slot" (click)="selectAvailability(avail)">
                <div class="slot-header">
                  <div class="slot-time">
                    {{ avail.startAt | date: 'HH:mm' }} - {{ avail.endAt | date: 'HH:mm' }}
                  </div>
                  <div class="slot-summary">
                    {{ getAvailableBlocksForDay({ date: currentSelectedDate, isCurrentMonth: true, isToday: false, availability: [avail] }) }} /
                    {{ getTotalBlocksForDay({ date: currentSelectedDate, isCurrentMonth: true, isToday: false, availability: [avail] }) }} disponibles
                  </div>
                </div>
                
                <!-- Detailed Blocks View -->
                @if (avail.blocks && avail.blocks.length > 0) {
                  <div class="blocks-details">
                    <div class="blocks-grid">
                      @for (block of avail.blocks; track block.id) {
                        <div class="block-item"
                             [class.booked]="block.isBooked"
                             [class.available]="!block.isBooked"
                             [class.past-block]="isBlockInPast(block)">
                          <div class="block-time">
                            {{ block.startAt | date: 'HH:mm' }} - {{ block.endAt | date: 'HH:mm' }}
                          </div>
                          <div class="block-status">
                            @if (block.isBooked) {
                              <span class="status-booked">ðŸ“… Reservado</span>
                            } @else {
                              <span class="status-available">âœ… Disponible</span>
                            }
                            @if (getBlockPatientName(block)) {
                              <span class="patient-name">- {{ getBlockPatientName(block) }}</span>
                            }
                          </div>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        } @else {
          <div class="no-availability-state">
            <div class="empty-icon">ðŸ“…</div>
            <h5>No hay turnos este dÃ­a</h5>
            <p>No se cargÃ³ disponibilidad para este dÃ­a.</p>
            <button type="button" class="btn btn-primary" (click)="selectDay({ date: currentSelectedDate, isCurrentMonth: true, isToday: false, availability: [] })">
              Configurar disponibilidad
            </button>
          </div>
        }
      } @else {
        <div class="no-availability-state">
          <p>No hay disponibilidad para este dÃ­a</p>
        </div>
      }
    </div>
  } @else {
    <div class="calendar-instructions">
      <div class="instructions-content">
        <div class="instruction-icon">ðŸ“…</div>
        <h4>Vista de calendario activa</h4>
        <p>HacÃ© clic en un dÃ­a que tenga <span class="has-availability">disponibilidad</span> para ver el horario detallado con bloques disponibles y reservados.</p>
        <div class="legend">
          <div class="legend-item">
            <div class="legend-color available"></div>
            <span>DÃ­as con disponibilidad</span>
          </div>
          <div class="legend-item">
            <div class="legend-color today"></div>
            <span>Hoy</span>
          </div>
        </div>
      </div>
    </div>
  }
</div>
