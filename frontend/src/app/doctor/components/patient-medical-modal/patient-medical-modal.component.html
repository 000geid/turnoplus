<div class="modal-overlay" (click)="onClose()">
  <div class="modal-dialog" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2 class="modal-title">Historial Médico - {{ patientName }}</h2>
      <button type="button" class="modal-close" (click)="onClose()" aria-label="Cerrar">
        ×
      </button>
    </div>

    <div class="modal-tabs">
      <button
        type="button"
        class="modal-tab"
        [class.modal-tab--active]="activeTab() === 'history'"
        (click)="onTabChange('history')"
      >
        Historial
      </button>
      <button
        type="button"
        class="modal-tab"
        [class.modal-tab--active]="activeTab() === 'new'"
        (click)="onTabChange('new')"
      >
        Nuevo Registro
      </button>
    </div>

    <div class="modal-content">
      @if (activeTab() === 'history') {
        <div class="history-tab">
          @if (loadingHistory()) {
            <p class="history-loading">Cargando historial...</p>
          } @else if (patientHistory().length === 0) {
            <div class="history-empty">
              <mat-icon fontIcon="history"></mat-icon>
              <p>Este paciente no tiene registros médicos aún.</p>
              <span>Usá la pestaña <strong>Nuevo Registro</strong> para comenzar el seguimiento.</span>
            </div>
          } @else {
            <div class="history-timeline">
              @for (record of patientHistory(); track trackByRecordId($index, record)) {
                <article class="timeline-item">
                  <div class="timeline-marker"></div>
                  <div class="timeline-card">
                    <div class="timeline-card__meta">
                      <div>
                        <p class="meta-date">
                          {{ record.created_at | date: "EEEE d 'de' MMMM": undefined : 'es-ES' }}
                        </p>
                        <span class="meta-time">
                          {{ record.created_at | date: 'HH:mm':undefined:'es-ES' }}
                        </span>
                      </div>
                      <span class="meta-chip">
                        Dr. {{ record.doctor_name || ('#' + record.doctor_id) }}
                      </span>
                    </div>

                    <div class="timeline-card__content">
                      @if (record.diagnosis) {
                        <div class="timeline-field">
                          <span class="field-label">Diagnóstico</span>
                          <p class="field-value">{{ record.diagnosis }}</p>
                        </div>
                      }

                      @if (record.treatment) {
                        <div class="timeline-field">
                          <span class="field-label">Tratamiento</span>
                          <p class="field-value">{{ record.treatment }}</p>
                        </div>
                      }

                      @if (record.notes) {
                        <div class="timeline-field">
                          <span class="field-label">Notas</span>
                          <p class="field-value">{{ record.notes }}</p>
                        </div>
                      }

                      @if (!record.diagnosis && !record.treatment && !record.notes) {
                        <p class="field-empty">
                          Este registro no contiene detalles adicionales.
                        </p>
                      }
                    </div>
                  </div>
                </article>
              }
            </div>
          }
        </div>
      }

      @if (activeTab() === 'new') {
        <div class="new-record-tab">
          <p class="new-record-helper">
            Registrá diagnósticos, tratamientos y observaciones clave para mantener actualizado el historial del paciente.
          </p>
          <form [formGroup]="newRecordForm" (ngSubmit)="onSubmitNewRecord()">
            <div class="form-group">
              <label>
                <span>Diagnóstico</span>
                <input
                  type="text"
                  class="input"
                  formControlName="diagnosis"
                  placeholder="Diagnóstico del paciente"
                />
              </label>
            </div>

            <div class="form-group">
              <label>
                <span>Tratamiento</span>
                <textarea
                  class="input textarea"
                  rows="3"
                  formControlName="treatment"
                  placeholder="Tratamiento prescrito"
                ></textarea>
              </label>
            </div>

            <div class="form-group">
              <label>
                <span>Notas</span>
                <textarea
                  class="input textarea"
                  rows="4"
                  formControlName="notes"
                  placeholder="Notas adicionales sobre la consulta"
                ></textarea>
              </label>
            </div>

            <!-- Messages now handled by toast notifications -->

            <div class="form-actions">
              <button
                type="submit"
                class="btn btn-primary"
                [disabled]="savingRecord()"
              >
                {{ savingRecord() ? 'Guardando...' : 'Crear Registro' }}
              </button>
              <button
                type="button"
                class="btn btn-secondary"
                (click)="onClose()"
              >
                Cancelar
              </button>
            </div>
          </form>
        </div>
      }
    </div>
  </div>
</div>
