<section class="patient-booking">
  <header class="patient-booking__header">
    <div>
      <h3>Reservar nuevo turno</h3>
      <p>Busc√° un profesional y eleg√≠ un horario disponible en su agenda.</p>
    </div>
  </header>

  <!-- Doctor Selection -->
  <app-doctor-autocomplete
    [doctors]="doctors()"
    [selectedDoctor]="selectedDoctor()"
    [loading]="isLoadingDoctors()"
    label="Seleccionar profesional"
    placeholder="Escrib√≠ el nombre o especialidad..."
    [showSpecialties]="true"
    [doctorAvailabilities]="getDoctorAvailabilityMap()"
    (doctorSelected)="onDoctorSelected($event)"
    (searchChanged)="onSearchChanged($event)"
  />

  <!-- Availability Summary -->
  @if (selectedDoctor(); as doctor) {
    <div class="availability-summary">
      <div class="selected-doctor-info">
        <h4>Disponibilidad de {{ doctor.full_name || doctor.email }}</h4>
        @if (doctor.specialty) {
          <p class="doctor-specialty">{{ doctor.specialty }}</p>
        }
      </div>
      
      @if (availableBlocks().length > 0) {
        <div class="summary-stats">
          <div class="stat-item">
            <span class="stat-number">{{ getQuickAvailabilitySummary().today }}</span>
            <span class="stat-label">hoy</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getQuickAvailabilitySummary().week }}</span>
            <span class="stat-label">esta semana</span>
          </div>
          <div class="stat-item">
            <span class="stat-number">{{ getQuickAvailabilitySummary().month }}</span>
            <span class="stat-label">este mes</span>
          </div>
        </div>
      }
    </div>

    <div class="calendar-section">
      <app-shared-calendar
        mode="availability"
        [data]="availableBlocks()"
        [loading]="isLoadingBlocks()"
        (daySelected)="onCalendarDaySelected($event)"
        (monthChanged)="onCalendarMonthChanged($event)"
      >
        <div slot="day-details">
          @if (selectedCalendarDay(); as selectedDay) {
            <div class="day-blocks">
              <h5>Turnos disponibles para {{ selectedDay.date | date: 'EEEE d MMMM' }}</h5>
              
              @if (getSelectedDayBlocks().length > 0) {
                <div class="blocks-grid">
                  @for (block of getSelectedDayBlocks(); track block.id) {
                    <div
                      class="appointment-block"
                      [class.past]="isBlockInPast(block)"
                      [class.clickable]="!isBlockInPast(block)"
                      (click)="!isBlockInPast(block) && onAppointmentBlockSelected(block)"
                    >
                      <div class="block-time">
                        {{ formatTimeSpanish(block.startAt) }} - {{ formatTimeSpanish(block.endAt) }}
                      </div>
                      <div class="block-status">
                        @if (isBlockInPast(block)) {
                          <span class="status-past">üïê Pasado</span>
                        } @else {
                          <span class="status-available">‚úÖ Disponible</span>
                          @if (isBooking()) {
                            <span class="booking-indicator">Reservando...</span>
                          }
                        }
                      </div>
                    </div>
                  }
                </div>
              } @else {
                <div class="no-blocks">
                  <div class="empty-icon">üìÖ</div>
                  <h6>No hay turnos disponibles este d√≠a</h6>
                  <p>Los d√≠as con disponibilidad est√°n marcados con puntos verdes en el calendario.</p>
                  @if (getFirstAvailableDay()) {
                    <button
                      type="button"
                      class="btn btn-outline"
                      (click)="navigateToNextAvailableDay()"
                    >
                      Ir al primer d√≠a disponible
                    </button>
                  }
                </div>
              }
            </div>
          } @else {
            <div class="calendar-instructions">
              <div class="instruction-content">
                <div class="instruction-icon">üìÖ</div>
                <p>Seleccion√° un d√≠a para ver los horarios disponibles</p>
                <p class="hint">Los d√≠as con disponibilidad est√°n marcados con puntos verdes.</p>
              </div>
            </div>
          }
        </div>
      </app-shared-calendar>
    </div>
  } @else {
    <div class="no-doctor-selected">
      <div class="empty-icon">üë®‚Äç‚öïÔ∏è</div>
      <h4>Selecion√° un profesional</h4>
      <p>Eleg√≠ un profesional de la lista para ver su disponibilidad de turnos.</p>
      <p class="hint">Los profesionales con disponibilidad disponible aparecer√°n con indicadores.</p>
    </div>
  }
</section>