<section class="patient-booking">
  <header class="patient-booking__header">
    <div>
      <h3>Reservar nuevo turno</h3>
      <p>ElegÃ­ un profesional y seleccionÃ¡ uno de los horarios disponibles.</p>
    </div>
  </header>

  <!-- Messages now handled by toast notifications -->

  <!-- Doctor Selection Calendar -->
  <app-doctor-selection-calendar
    [doctors]="doctors()"
    [selectedDoctorId]="selectedDoctorId()"
    [isLoadingDoctors]="isLoadingDoctors()"
    [doctorAvailabilityMap]="doctorAvailabilityMap()"
    (doctorSelected)="onDoctorSelected($event)"
    (viewModeChanged)="onViewModeChanged($event)"
  />

  <!-- View Toggle -->
  @if (selectedDoctor()) {
    <div class="view-toggle">
      <button
        type="button"
        class="toggle-btn"
        [class.active]="viewMode() === 'list'"
        (click)="onViewModeChange('list')"
      >
        ðŸ“‹ Lista
      </button>
      <button
        type="button"
        class="toggle-btn"
        [class.active]="viewMode() === 'calendar'"
        (click)="onViewModeChange('calendar')"
      >
        ðŸ“… Calendario
      </button>
    </div>
  }

  <!-- Content based on view mode -->
  @if (viewMode() === 'list') {
    @if (isLoadingAvailability()) {
      <p class="patient-booking__placeholder">Buscando turnos disponiblesâ€¦</p>
    } @else if (isLoadingBlocks()) {
      <p class="patient-booking__placeholder">Cargando bloques disponiblesâ€¦</p>
    } @else if (!availableBlocks().length) {
      <p class="patient-booking__placeholder">
        Este profesional no tiene bloques de turnos disponibles por ahora. ProbÃ¡ con otro horario o profesional.
      </p>
    } @else {
      <div class="blocks-section">
        <h4>Bloques de turnos disponibles</h4>
        <div class="blocks-grid">
          @for (block of availableBlocks(); track block.id) {
            <div class="block-card">
              <div class="block-info">
                <h5>{{ formatDateSpanish(block.startAt) }}</h5>
                <p class="time-range">
                  {{ formatTimeSpanish(block.startAt) }} - {{ formatTimeSpanish(block.endAt) }} hs
                </p>
                <p class="block-status available">
                  Disponible
                </p>
              </div>
              <button
                type="button"
                class="btn btn-primary"
                (click)="bookBlock(block)"
                [disabled]="isBooking()"
              >
                {{ isBooking() ? 'Reservandoâ€¦' : 'Reservar' }}
              </button>
            </div>
          }
        </div>
      </div>
    }
  } @else if (viewMode() === 'calendar') {
    @if (selectedDoctor()) {
      <app-patient-availability-calendar
        [doctors]="doctors()"
        [selectedDoctorId]="selectedDoctorId()"
        [loading]="isLoadingBlocks()"
        (doctorChanged)="onCalendarDoctorChange($event)"
        (appointmentBlockSelected)="onCalendarAppointmentBlockSelected($event)"
      />
    } @else {
      <div class="no-doctor-selected">
        <p>SeleccionÃ¡ un profesional para ver su calendario</p>
      </div>
    }
  }
</section>
