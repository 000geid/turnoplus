<div class="patient-availability-calendar">
  <!-- Doctor Filter -->
  <div class="calendar-header">
    <div class="doctor-filter">
      <label for="doctor-select" class="field-label">Seleccionar profesional:</label>
      <select 
        id="doctor-select" 
        class="input doctor-select" 
        [value]="selectedDoctorId || ''"
        (change)="onDoctorChange($any($event.target).value)"
        [disabled]="loading"
      >
        <option value="">Seleccion√° un profesional</option>
        @for (doctor of doctors; track doctor.id) {
          <option [value]="doctor.id">
            {{ doctor.full_name || doctor.email }}
            @if (doctor.specialty) {
              - {{ doctor.specialty }}
            }
          </option>
        }
      </select>
    </div>
  </div>

  @if (selectedDoctorId && selectedDoctor(); as doctor) {
    <div class="selected-doctor-info">
      <h4>Agenda de {{ doctor.full_name || doctor.email }}</h4>
      @if (doctor.specialty) {
        <p class="doctor-specialty">{{ doctor.specialty }}</p>
      }
    </div>

    <!-- Calendar Navigation -->
    <div class="calendar-nav">
      <button type="button" class="btn btn-secondary" (click)="previousMonth()" [disabled]="loading">
        <span class="icon">‚Äπ</span>
        Anterior
      </button>
      <h3 class="calendar-title">{{ monthName() }}</h3>
      <button type="button" class="btn btn-secondary" (click)="nextMonth()" [disabled]="loading">
        Siguiente
        <span class="icon">‚Ä∫</span>
      </button>
    </div>

    <button type="button" class="btn btn-outline today-btn" (click)="goToToday()" [disabled]="loading">
      Hoy
    </button>
  }

  @if (loading) {
    <div class="loading-state">
      <div class="loading-spinner"></div>
      <p>Cargando disponibilidad...</p>
    </div>
  } @else if (selectedDoctorId && selectedDoctor(); as doctor) {
    <!-- Calendar Grid -->
    <div class="calendar-grid">
      <!-- Day Headers -->
      <div class="day-headers">
        <div class="day-header weekend">Dom</div>
        <div class="day-header">Lun</div>
        <div class="day-header">Mar</div>
        <div class="day-header">Mi√©</div>
        <div class="day-header">Jue</div>
        <div class="day-header">Vie</div>
        <div class="day-header weekend">S√°b</div>
      </div>

      <!-- Calendar Days -->
      <div class="calendar-days">
        @for (day of calendarDays(); track day.date.toISOString()) {
          <div
            class="calendar-day"
            [class.current-month]="day.isCurrentMonth"
            [class.today]="day.isToday"
            [class.selected]="isDaySelected(day)"
            [class.has-availability]="hasAvailability(day)"
            [class.weekend]="isWeekend(day)"
            [class.past-day]="isPastDay(day)"
            [class.empty-day]="!hasAvailability(day) && day.isCurrentMonth"
            (click)="selectDay(day)"
          >
            <div class="day-number">{{ day.date.getDate() }}</div>
            
            @if (hasAvailability(day) && day.isCurrentMonth) {
              <div class="day-availability">
                <div class="availability-summary">
                  {{ getAvailableBlocksCount(day) }} 
                  @if (getAvailableBlocksCount(day) === 1) {
                    horario disponible
                  } @else {
                    horarios disponibles
                  }
                </div>
                
                <!-- Show first available block time -->
                @if (getBlocksForDay(day).length > 0) {
                  <div class="first-available-time">
                    {{ getBlocksForDay(day)[0].startAt | date: 'HH:mm' }} -
                    {{ getBlocksForDay(day)[0].endAt | date: 'HH:mm' }}
                  </div>
                }
              </div>
            } @else if (!hasAvailability(day) && day.isCurrentMonth && !isPastDay(day)) {
              <div class="no-availability">
                Sin turnos
              </div>
            }
            
            @if (day.isToday) {
              <div class="today-indicator">Hoy</div>
            }
          </div>
        }
      </div>
    </div>

    <!-- Selected Day Details -->
    @if (selectedDate(); as currentSelectedDate) {
      <div class="selected-day-details">
        <h4>Turnos disponibles para {{ currentSelectedDate | date: 'EEEE d MMMM' }}</h4>
        
        @if (getBlocksForSelectedDate().length > 0) {
          <div class="available-blocks">
            <div class="blocks-grid">
              @for (block of getBlocksForSelectedDate(); track block.id) {
                <div 
                  class="appointment-block"
                  [class.available]="!isBlockInPast(block)"
                  [class.past]="isBlockInPast(block)"
                  [class.booked]="block.isBooked"
                  (click)="!isBlockInPast(block) && !block.isBooked && selectAppointmentBlock(block)"
                  [class.clickable]="!isBlockInPast(block) && !block.isBooked"
                >
                  <div class="block-time">
                    {{ block.startAt | date: 'HH:mm' }} - {{ block.endAt | date: 'HH:mm' }}
                  </div>
                  <div class="block-status">
                    @if (isBlockInPast(block)) {
                      <span class="status-past">üïê Pasado</span>
                    } @else if (block.isBooked) {
                      <span class="status-booked">üìÖ Reservado</span>
                    } @else {
                      <span class="status-available">‚úÖ Disponible</span>
                    }
                  </div>
                </div>
              }
            </div>
          </div>
        } @else {
          <div class="no-availability-day">
            <div class="empty-icon">üìÖ</div>
            <h5>No hay turnos disponibles este d√≠a</h5>
            <p>Prob√° con otro d√≠a que tenga disponibilidad.</p>
          </div>
        }
      </div>
    } @else {
      <div class="calendar-instructions">
        <div class="instructions-content">
          <div class="instruction-icon">üìÖ</div>
          <h4>Seleccion√° un d√≠a para ver los horarios disponibles</h4>
          <p>Hac√© clic en un d√≠a que tenga <span class="has-availability">disponibilidad</span> para ver los horarios espec√≠ficos que pod√©s reservar.</p>
          <div class="legend">
            <div class="legend-item">
              <div class="legend-color available"></div>
              <span>D√≠as con turnos disponibles</span>
            </div>
            <div class="legend-item">
              <div class="legend-color today"></div>
              <span>Hoy</span>
            </div>
            <div class="legend-item">
              <div class="legend-color empty"></div>
              <span>Sin turnos disponibles</span>
            </div>
          </div>
        </div>
      </div>
    }
  } @else {
    <div class="no-doctor-selected">
      <div class="empty-icon">üë®‚Äç‚öïÔ∏è</div>
      <h4>Seleccion√° un profesional</h4>
      <p>Eleg√≠ un profesional de la lista para ver su agenda y disponibilidad de turnos.</p>
    </div>
  }
</div>