<div class="unified-user-management">
  <div class="page-header">
    <div class="page-header__titles">
      <p class="page-eyebrow">Usuarios</p>
      <h2>Gestión de Usuarios</h2>
      <p>Gestioná pacientes, doctores y administradores.</p>
    </div>
    <button class="btn btn-primary" (click)="showCreateUserForm()" [disabled]="loading">
      <i class="material-icons">person_add</i>
      Nuevo Usuario
    </button>
  </div>

  <!-- Filter chips -->
  <div class="role-chips">
    <button type="button" class="role-chip" [class.active]="roleFilter === 'all'" (click)="setRoleFilter('all')">
      <i class="material-icons">all_inclusive</i>
      <span class="label">Todos</span>
      <span class="count">{{ getStats()['total'] }}</span>
    </button>
    <button type="button" class="role-chip" [class.active]="roleFilter === 'patient'"
      (click)="setRoleFilter('patient')">
      <i class="material-icons">person</i>
      <span class="label">Pacientes</span>
      <span class="count">{{ getStats()['patients'] }}</span>
    </button>
    <button type="button" class="role-chip" [class.active]="roleFilter === 'doctor'" (click)="setRoleFilter('doctor')">
      <i class="material-icons">medical_services</i>
      <span class="label">Doctores</span>
      <span class="count">{{ getStats()['doctors'] }}</span>
    </button>
    <button type="button" class="role-chip" [class.active]="roleFilter === 'admin'" (click)="setRoleFilter('admin')">
      <i class="material-icons">admin_panel_settings</i>
      <span class="label">Administradores</span>
      <span class="count">{{ getStats()['admins'] }}</span>
    </button>
  </div>

  <!-- Search Bar -->
  <div class="filter-bar">
    <mat-form-field appearance="outline" class="search-field">
      <mat-label>Buscar usuarios...</mat-label>
      <mat-icon matPrefix>search</mat-icon>
      <input matInput [(ngModel)]="searchQuery" (ngModelChange)="onSearchChange()"
        placeholder="Buscar por email, nombre, especialidad...">
      <button matSuffix mat-icon-button type="button" *ngIf="searchQuery" (click)="searchQuery = ''; onSearchChange()"
        aria-label="Limpiar búsqueda">
        <mat-icon>close</mat-icon>
      </button>
    </mat-form-field>
  </div>

  <!-- Error message -->
  <div *ngIf="error" class="alert alert-error">
    <i class="material-icons">error</i>
    {{ error }}
  </div>

  <!-- Loading state -->
  <div *ngIf="loading && filteredUsers.length === 0" class="loading">
    <i class="material-icons">refresh</i>
    Cargando usuarios...
  </div>

  <!-- Users list -->
  <div *ngIf="!loading || filteredUsers.length > 0" class="user-list">
    <div *ngIf="filteredUsers.length === 0" class="empty-state">
      <i class="material-icons">search_off</i>
      <p>No se encontraron usuarios</p>
      <button class="btn btn-secondary"
        (click)="searchQuery = ''; roleFilter = 'all'; onRoleFilterChange(); onSearchChange()">
        Limpiar filtros
      </button>
    </div>

    <div *ngFor="let user of filteredUsers" class="user-card">
      <div class="user-card__content">
        <div class="user-card__header">
          <div class="user-info">
            <i class="material-icons user-icon">{{ getRoleIcon(user.role) }}</i>
            <div>
              <h3>{{ user.full_name || user.email }}</h3>
              <span class="user-role">{{ getRoleDisplayName(user.role) }}</span>
            </div>
          </div>
          <span class="user-status" [class.active]="user.is_active">
            {{ user.is_active ? 'Activo' : 'Inactivo' }}
          </span>
        </div>

        <div class="user-card__details">
          <p class="user-email">
            <i class="material-icons">email</i>
            {{ user.email }}
          </p>

          <!-- Patient specific details -->
          <div *ngIf="user.role === 'patient' && 'medical_record_number' in user">
            <p *ngIf="user.medical_record_number" class="user-detail">
              <i class="material-icons">badge</i>
              Expediente: {{ user.medical_record_number }}
            </p>

          </div>

          <!-- Doctor specific details -->
          <div *ngIf="user.role === 'doctor' && 'specialty' in user">
            <p *ngIf="user.specialty" class="user-detail specialty">
              <i class="material-icons">work</i>
              {{ user.specialty }}
            </p>
            <p *ngIf="user.license_number" class="user-detail">
              <i class="material-icons">badge</i>
              {{ user.license_number }}
            </p>
            <p *ngIf="user.years_experience" class="user-detail">
              <i class="material-icons">schedule</i>
              {{ user.years_experience }} años de experiencia
            </p>
            <p class="user-detail">
              <i class="material-icons">business</i>
              {{ getOfficeName(user.office_id) }}
            </p>
          </div>

          <!-- Admin specific details -->
          <div *ngIf="user.role === 'admin'">
            <p class="user-detail">
              <i class="material-icons">admin_panel_settings</i>
              Administrador
            </p>
          </div>
        </div>
      </div>

      <button class="user-card__edit-button" type="button" (click)="showEditUserForm(user)" [disabled]="loading"
        aria-label="Editar usuario">
        <i class="material-icons">edit</i>
      </button>
    </div>

    <!-- Pagination component -->
    <app-pagination [currentPage]="pagination.page" [totalPages]="totalPages" [pageSize]="pagination.size"
      [totalItems]="totalUsers" [showPageSizeSelector]="true" [showInfo]="true" (pageChange)="onPageChange($event)"
      (pageSizeChange)="onPageSizeChange($event)">
    </app-pagination>
  </div>

  <!-- Create/Edit Form Modal -->
  <div *ngIf="showCreateForm" class="modal-overlay" (click)="cancelForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal__header">
        <h3>{{ editingUser ? 'Editar Usuario' : 'Nuevo Usuario' }}</h3>
        <button class="btn btn-icon" (click)="cancelForm()">
          <i class="material-icons">close</i>
        </button>
      </div>

      <form (ngSubmit)="onSubmit()" class="modal__form">
        <!-- Role Selection -->
        <div class="form-group">
          <label for="role">Tipo de Usuario *</label>
          <select id="role" [(ngModel)]="selectedRole" (ngModelChange)="onRoleChange()" name="role" required
            class="form-control" [disabled]="!!editingUser">
            <option value="patient">Paciente</option>
            <option value="doctor">Doctor</option>
            <option value="admin">Administrador</option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="email">Email *</label>
            <input type="email" id="email" [(ngModel)]="formData.email" name="email" required
              placeholder="usuario@ejemplo.com" class="form-control">
          </div>

          <div class="form-group">
            <label for="password">{{ editingUser ? 'Nueva Contraseña' : 'Contraseña' }} *</label>
            <input type="password" id="password" [(ngModel)]="formData.password" name="password"
              [required]="!editingUser" placeholder="Contraseña" class="form-control">
            <small *ngIf="editingUser" class="form-help">Dejar vacío para mantener la contraseña actual</small>
          </div>
        </div>

        <div class="form-group">
          <label for="full_name">Nombre Completo</label>
          <input type="text" id="full_name" [(ngModel)]="formData.full_name" name="full_name"
            placeholder="Nombre completo" class="form-control">
        </div>

        <!-- Patient specific fields -->
        <div *ngIf="selectedRole === 'patient'" class="role-specific-fields">
          <h4>Datos del Paciente</h4>
          <div class="form-row">

            <div class="form-group">
              <label for="medical_record_number">Número de Expediente</label>
              <input type="text" id="medical_record_number" [(ngModel)]="formData.medical_record_number"
                name="medical_record_number" placeholder="EXP-001" class="form-control">
            </div>
          </div>
          <div class="form-group">
            <label for="emergency_contact">Contacto de Emergencia</label>
            <input type="text" id="emergency_contact" [(ngModel)]="formData.emergency_contact" name="emergency_contact"
              placeholder="Nombre y teléfono" class="form-control">
          </div>
        </div>

        <!-- Doctor specific fields -->
        <div *ngIf="selectedRole === 'doctor'" class="role-specific-fields">
          <h4>Datos del Doctor</h4>
          <div class="form-row">
            <div class="form-group">
              <label for="specialty">Especialidad</label>
              <input type="text" id="specialty" [(ngModel)]="formData.specialty" name="specialty"
                placeholder="Clínica General" class="form-control">
            </div>
            <div class="form-group">
              <label for="license_number">Número de Matrícula</label>
              <input type="text" id="license_number" [(ngModel)]="formData.license_number" name="license_number"
                placeholder="MAT-12345" class="form-control">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="years_experience">Años de Experiencia</label>
              <input type="number" id="years_experience" [(ngModel)]="formData.years_experience" name="years_experience"
                min="0" class="form-control">
            </div>
            <div class="form-group">
              <label for="office_id">Consultorio</label>
              <select id="office_id" [(ngModel)]="formData.office_id" name="office_id" class="form-control">
                <option [value]="undefined">Sin asignar</option>
                <option *ngFor="let office of offices" [value]="office.id">
                  {{ office.name || office.code }}
                </option>
              </select>
            </div>
          </div>
        </div>

        <!-- Admin specific fields -->
        <div *ngIf="selectedRole === 'admin'" class="role-specific-fields">
          <h4>Datos del Administrador</h4>
          <div class="form-group">
            <label for="admin_role">Rol de Administrador</label>
            <select id="admin_role" [(ngModel)]="formData.admin_role" name="admin_role" class="form-control">
              <option value="support">Soporte</option>
              <option value="manager">Gerente</option>
              <option value="superadmin">Super Administrador</option>
            </select>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group form-checkbox">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="formData.is_active" name="is_active">
              <span class="checkmark"></span>
              Usuario activo
            </label>
          </div>

          <div class="form-group form-checkbox">
            <label class="checkbox-label">
              <input type="checkbox" [(ngModel)]="formData.is_superuser" name="is_superuser">
              <span class="checkmark"></span>
              Superusuario
            </label>
          </div>
        </div>

        <div class="modal__actions">
          <button type="button" class="btn btn-secondary" (click)="cancelForm()">
            Cancelar
          </button>
          <button *ngIf="editingUser" type="button" class="btn btn-danger" (click)="deleteUser(editingUser)"
            [disabled]="loading">
            <i class="material-icons">delete</i>
            Eliminar
          </button>
          <button type="submit" class="btn btn-primary"
            [disabled]="loading || !formData.email.trim() || (!editingUser && !formData.password.trim())">
            <i *ngIf="loading" class="material-icons">refresh</i>
            {{ editingUser ? 'Actualizar' : 'Crear' }}
          </button>
        </div>
      </form>
    </div>
  </div>
</div>